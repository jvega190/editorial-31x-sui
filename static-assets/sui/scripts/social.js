!function(a){"use strict";var b=a.crafter,c="$placeholder$",d={window:a,noop:function(){},define:function(b,e,f,g){(f===!0||f===!1||"string"==typeof f)&&(g=f,f=void 0),"undefined"==typeof g&&(g=!0);var h=this,i=[];b=b.replace(/\{.*?\}/g,function(a){a=a.substr(1,a.length-2);var b=a.split(":");return b.length>1?"CONST"===b[0].toUpperCase()&&i.push(h.Constants.get(b[1])):i.push(a),c});for(var j,k=f||this,l=b.split("."),m=l.length,n=m-1,o=0;m>o;o++)j=l[o],j===c&&(j=i.shift()),o===n&&"undefined"!=typeof e?k[j]=e:j in k||(k[j]={}),k=k[j];return"string"==typeof g&&(b=g),g&&d.amd(b,e,f===a),e},noConflict:function(c){return c?b:(a.crafter=b,this)},amd:function(b,c,d){"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=c:(d&&(a[b]=c),"function"==typeof define&&define.amd&&define(b,[],function(){return c}))}};d.amd("crafter",d,!0);var e={};for(var f in a)e[f]=a;var g,h="undefined";d.define("social",{window:a,windowCopy:e,parentScope:d,noop:d.noop,noConflict:function(a){var b=this.window[a];return this.window[a]=this.windowCopy[a],b},define:function(){d.define.apply(this,arguments)},get:function(b,c){1===arguments.length&&(c=this);for(var d,e=b.split("."),f=c||a,g=0,h=e.length;h>g&&(d=e[g],"undefined"!=typeof f);g++)f=f[d];return c!==a&&"undefined"==typeof f?this.get(b,a):f},socialise:function(){var a=this.getDirector();a.socialise.apply(a,arguments)},resource:function(a){return this.string.fmt("%@%@",this.Cfg("url.base"),a)},url:function(b,c,e){if("object"==typeof c){var f={};for(var g in c)f[g]=a.encodeURIComponent(c[g]);c=f}else c&&(c=a.encodeURIComponent(c));var h,j,k,l=this.Cfg("url."+b),m=!1;if("object"==typeof l&&(l.absolute&&(m=!0),l=l.value),l.match(i)&&(m=!0),m||(h=this.Cfg("url.service"),j=(h.match(i)||[""])[0]),k=(m?l:j+this.string.fmt("{base}/{path}/{action}",{base:h.substr(j.length),path:b.replace(/\./g,"/"),action:l}).replace("/.json",".json").replace(/[\/\/]+/g,"/")).fmt(c||{}),e){if("object"==typeof e){if(!d.social.$)throw"app.js method url: Query option not available before social framework initialization";e=d.social.$.param(e)}k+=-1===k.indexOf("?")?"?"+e:"&"+e}return k},getDirector:function(){if(!g){var a=this.Cfg("director"),b=this.get(a.cls);g=new b(a.cfg)}return g},string:{fmt:function(a){if("object"==typeof arguments[1]){var b=arguments[1];return a.replace(/\{.*?\}/g,function(a){return b[a.substr(1,a.length-2)]})}var c=0,d=Array.prototype.slice.call(arguments,1);return a.replace(/%@([0-9]+)?/g,function(a,b){return b=b?parseInt(b,10)-1:c++,c>=d.length&&(c=0),a=d[b],null===a?"(null)":typeof a===h?"":a})},loc:function(a){var b=d.social.util.get(this.LOCALE,a);return"undefined"==typeof b&&(b=this.LOCALE[a]),b},LOCALE:{months:["January","February","March","April","May","June","July","August","September","October","November","December"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]}}});var i=/^(https?:)?\/\//i}(window),function(a){"use strict";var b={MODERATION_STATUS_UNMODERATED:"UNMODERATED",MODERATION_STATUS_PENDING:"PENDING",MODERATION_STATUS_APPROVED:"APPROVED",MODERATION_STATUS_SPAM:"SPAM",MODERATION_STATUS_TRASH:"TRASH",EVENT_SOCIAL_CONFIG_CHANGED:"crafter.social.configuration.changed",EVENT_AREAS_VISIBILITY_CHANGE:"crater.social.event.areas.visibility.change",EVENT_UNAUTHORISED_RESPONSE:"crafter.social.event.unauthorised.response",EVENT_USER_AUTHENTICATION_SUCCESS:"crafter.social.event.user.authentication.success",EVENT_USER_AUTHENTICATION_FAILED:"crafter.social.event.user.authentication.failed",EVENT_SOCIAL_NOCOMMENT:"crater.social.event.no.comments.action",AREA_VISIBILITY_MODE_REVEAL:"area.visibility.mode.reveal",AREA_VISIBILITY_MODE_HOVER:"area.visibility.mode.hover",AREA_VISIBILITY_MODE_HIDE:"area.visibility.mode.hide",EVENT_REVEAL_DISCUSSIONS:"crafter.social.reveal.discussions.{context}:{target}",EVENT_DISCUSSION_WATCHED:"crafter.social.discussion.watched.{context}:{target}",DESTROY:{}};a.define("Constants",{get:function(c){if(1===arguments.length)return b[c];var d=Array.prototype.slice.call(arguments,0);return Array.prototype.splice.call(d,0,1,b[c]),a.string.fmt.apply(a.string,d)},define:function(c,d){if("object"==typeof c){d=c;for(c in d)this.define(c,d[c])}else c in b?a.util.log("Constant %@ is already defined (value: %@). Value not changed.",c,a.Constants.get(c)):b[c]=d;return!0}},"social.Constants")}(crafter.social),function(a){"use strict";var b={director:{cls:"component.Director",cfg:{}},url:{base:"/",files:"/attachment/{attachmentId}?context={context}",service:"/api/3/",templates:"templates/",security:{value:"/crafter-social/crafter-security-login",active:"/crafter-social/crafter-security-current-auth"},subscriptions:{subscribe:"{target}.json",unsubscribe:"{target}.json"},profile:{avatar:"/{id}?context={context}&ts{ts}"},threads:{"{target}":{comments:{value:"?context={context}","{id}":{}},subscribe:"?context={context}",unsubscribe:"?context={context}"},"{_id}":{subscribe:"?context={context}",unsubscribe:"?context={context}"}},comments:{value:"?context={context}","{_id}":{value:"?context={context}",votes:{value:"",neutral:"",down:"",up:""},flags:{value:"?context={context}","{flagId}":"?context={context}"},attachments:{value:"","{fileId}":"?context={context}"},moderate:"?context={context}"}},ugc:{target:".json",create:".json",like:"/{id}.json",unlike:"/{id}.json",dislike:"/{id}.json",undislike:"/{id}.json",flag:"/{id}.json",unflag:"/{id}.json",file:"{attachmentId}.json",get_ugc:"{id}.json?context={context}",moderation:{"{id}":"/status.json","{moderationStatus}":{".json":"",target:".json"}},"{id}":{get_attachments:".json?context={context}",add_attachment:".json"}}}};a.define("Cfg",function(c,d){if(1!==arguments.length)return a.define(c,d,b,!1),!0;if("object"!=typeof c)return a.get(c,b);for(var e in c)a.Cfg(e,c[e])},"social.Cfg");var c=a.window.crafterSocial_cfg;"undefined"!=typeof c&&a.Cfg(c)}(crafter.social),function(a){"use strict";a.window.CKEDITOR_BASEPATH=crafter.social.resource("libs/ckeditor/")}(crafter.social),function(){function a(a){var b=a.getStyle("overflow-y"),c=a.getDocument(),d=CKEDITOR.dom.element.createFromHtml('<span style="margin:0;padding:0;border:0;clear:both;width:1px;height:1px;display:block;">'+(CKEDITOR.env.webkit?"&nbsp;":"")+"</span>",c);c[CKEDITOR.env.ie?"getBody":"getDocumentElement"]().append(d);var e=d.getDocumentPosition(c).y+d.$.offsetHeight;return d.remove(),a.setStyle("overflow-y",b),e}function b(a){var b=a.document,c=b.getBody(),d=b.getDocumentElement();return"BackCompat"==b.$.compatMode?c:d}var c=function(c,d){if(!c.window)return null;var e=c.getCommand("maximize");if(e&&e.state==CKEDITOR.TRISTATE_ON)return null;var f=b(c),g=c.window.getViewPaneSize().height,h=a(f);h+=c.config.autoGrow_bottomSpace||0;var i=void 0!=c.config.autoGrow_minHeight?c.config.autoGrow_minHeight:200,j=c.config.autoGrow_maxHeight||1/0;return h=Math.max(h,i),h=Math.min(h,j),h!=g&&d!=h&&(h=c.fire("autoGrow",{currentHeight:g,newHeight:h}).newHeight,c.resize(c.container.getStyle("width"),h,!0),d=h),f.$.scrollHeight>f.$.clientHeight&&j>h?f.setStyle("overflow-y","hidden"):f.removeStyle("overflow-y"),d};CKEDITOR.plugins.add("autogrow",{init:function(a){a.elementMode!=CKEDITOR.ELEMENT_MODE_INLINE&&a.on("instanceReady",function(){var d,e=a.editable();if(e.isInline())a.ui.space("contents").setStyle("height","auto");else{a.addCommand("autogrow",{exec:function(a){d=c(a,d)},modes:{wysiwyg:1},readOnly:1,canUndo:!1,editorFocus:!1});var f={contentDom:1,key:1,selectionChange:1,insertElement:1,mode:1};for(var g in f)a.on(g,function(a){"wysiwyg"==a.editor.mode&&setTimeout(function(){d=c(a.editor,d),d=c(a.editor,d)},100)});a.on("afterCommandExec",function(e){if("maximize"==e.data.name&&"wysiwyg"==e.editor.mode)if(e.data.command.state==CKEDITOR.TRISTATE_ON){var f=b(a);f.removeStyle("overflow")}else d=c(a,d)}),a.config.autoGrow_onStartup&&a.execCommand("autogrow")}})}})}(),function(social){"use strict";var window=social.window;social.$=window.$.noConflict(),social.Backbone=window.Backbone.noConflict(),social.underscore=window._.noConflict(),social.EventProvider=social.underscore.clone(social.Backbone.Events);var $=social.$;$.support.cors=!0,-1===social.window.navigator.userAgent.toLowerCase().indexOf("firefox")&&$.ajaxSetup({crossDomain:!0,xhrFields:{withCredentials:!0}}),social.define("request",$.ajax,!1),social.define("util",$.extend({},social.underscore,{emptyFn:social.noop,guid:function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()}}(),get:function(a,b){return 1===arguments.length?social.get(a,window):social.get(b,a)},instance:function(a){var b,c,d=social.get(a)||social.get(a,window),e=Array.prototype.splice.call(arguments,1),f=function(){};return f.prototype=d.prototype,b=new f,c=d.apply(b,e),Object(c)===c?c:b},inherit:function(a,b,c){var d=function(){};return d.prototype=b.prototype,a.prototype=new d,a.prototype.constructor=a,a.superclass=b.prototype,$.extend(a.prototype,c||{}),b.prototype.constructor===Object.prototype.constructor&&(b.prototype.constructor=b),a},template:function(a,b){var c=social.TemplateEngine.compile(a);return c(b)},isHTML:function(){var a=/(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/;return function(b){return a.exec(b)}}(),fromJSON:function(a){return JSON.parse(a)},log:function(){if(!console||!console.log)return!1;var a=social.string.fmt.apply(social.string,arguments);console.log(a)},checkJSON:function(){var a=/^[\],:{}\s]*$/,b=/\\["\\\/bfnrtu]/g,c=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,d=/(?:^|:|,)(?:\s*\[)+/g;return function(e){return a.test(e.replace(b,"@").replace(c,"]").replace(d,""))}}()}),!1),String.prototype.fmt=function(){var a=Array.prototype.slice.call(arguments,0);return a.splice(0,0,this+""),social.string.fmt.apply(social.string,a)},String.prototype.loc=function(){return social.string.loc(this)},Array.prototype.j=function(a){return this.join(a||"")},Array.prototype.every||(Array.prototype.every=function(a){for(var b=!0,c=0,d=this.length;d>c&&(b=a(this[c],c),b);c++);return b}),Date.now||(Date.now=function(){return(new Date).getTime()}),window.JSON||(window.JSON={parse:function(json){var regExp=/[^,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]/,test=json.replace(/"(\\.|[^"\\])*"/g,"");if(regExp.test(test)){var error="Supplied content is not JSON";throw"Error"in window?new Error(error):error}return eval("("+json+")")}})}(crafter.social),function(a){"use strict";function b(f){var g=this,h=this.guid=d.guid();i[h]={CACHE:{}},this.cfg=e.extend({},b.DEFAULTS,f||{}),e.each(this.cfg.handlers,function(b,c){var e=c.dispatch?"self"===c.dispatch?g:c.dispatch:g,f=c.context?"self"===c.context?g:c.context:g,h=c.handler;g.listenTo(e,b,d.isFunction(h)?h:f[h]||a.noop)}),e(document).ajaxComplete(function(b,d){var e;403===d.status?g.trigger(c.get("EVENT_UNAUTHORISED_RESPONSE")):404===d.status?(e=new a.view.Modal({events:{"click [data-dismiss]":"destroy"},modal:{show:!0}}).render(),e.set({title:"Not Found",body:"Sorry, the requested URL was not found.",footer:'<button data-dismiss class="btn btn-default">Close</button>'})):500===d.status||504===d.status||502===d.status||503===d.status||511===d.status?(e=new a.view.Modal({events:{"click [data-dismiss]":"destroy"},modal:{show:!0}}).render(),e.set({title:"Error",body:"The server responded with an error, please verify your data and try again in a few seconds.",footer:'<button data-dismiss class="btn btn-default">Close</button>'})):403===d.status&&(e=new a.view.Modal({events:{"click [data-dismiss]":"destroy"},modal:{show:!0}}).render(),e.set({title:"Error",body:"You don't have permissions to access that resource.",footer:'<button data-dismiss class="btn btn-default">Close</button>'}))}),this.cache("profile",new a.model.Profile),this.checkSessionProfile()}var c=a.Constants,d=a.util,e=a.$,f=c.get("AREA_VISIBILITY_MODE_HOVER"),g=[c.get("AREA_VISIBILITY_MODE_HOVER"),c.get("AREA_VISIBILITY_MODE_REVEAL"),c.get("AREA_VISIBILITY_MODE_HIDE")],h=null,i={};b.DEFAULTS={socialbar:{cls:"",cfg:{}},view:{discussion:{cls:"view.Popover",cfg:{}},parasite:{cls:"view.Commentable",cfg:{}}},ctrl:{main:{cls:"controller.Base",cfg:{}}},handlers:function(){var a={};return a[c.get("EVENT_UNAUTHORISED_RESPONSE")]={handler:"authenticate"},a[c.get("EVENT_USER_AUTHENTICATION_SUCCESS")]={handler:"setProfile"},a}()},b.prototype=e.extend({},a.EventProvider,{cache:function(a,b){return 1===arguments.length?i[this.guid].CACHE[a]:void(i[this.guid].CACHE[a]=b)},getProfile:function(){return this.cache("profile")},setProfile:function(b){return b instanceof a.model.Profile||(b=new a.model.Profile(b)),this.cache("profile",b)},authenticate:function(){var b=new(a.get("view.Auth"))({model:this.getProfile(),modal:{show:!0}});b.$el.on("shown.bs.modal",function(){b.$el.find("input:first").select()}),b.render()},checkSessionProfile:function(){var a=this.getProfile();a.getFromSession()},getAreaVisibilityMode:function(){return f},setAreaVisibilityMode:function(b){if(-1===a.util.indexOf(g,b))throw new Error("Unknown mode %@ supplied to Director (setAreaVisibilityMode)".fmt(b));f=b,this.trigger(c.get("EVENT_AREAS_VISIBILITY_CHANGE"),b)},setActiveDiscussionViewer:function(b,c){var d=this.cache(b);return d||(d=new(a.get(b))(c||{}),this.cache(b,d)),this.cache("activeView",b),d},getActiveDiscussionViewer:function(){return this.cache("activeView")||this.setActiveDiscussionViewer(this.cfg.view.discussion.cls,this.cfg.view.discussion.cfg),this.cache("activeView")},socialise:function(c){e.ajaxSetup({cache:!1});var d=e.extend(!0,{},b.DEFAULTS,c),f=a.get(d.ctrl.main.cls)||a.get(d.ctrl.main.cls,window),g=a.get(d.view.parasite.cls)||a.get(d.view.parasite.cls,window),i=d.socialbar?a.get(d.socialbar.cls):!1,j=new f(null,{target:d.target,context:d.context,model:a.model.Comment});this.cache(a.string.fmt("controller.%@.%@",d.context,d.target),j);var k=new g(e.extend({target:d.target,context:d.context,sortBy:"createdDate",sortOrder:"DESC",collection:j},d.view.parasite.cfg));this.cache(a.string.fmt("parasite.%@.%@",d.context,d.target),k),i&&!h&&(h=new i(d.socialbar.cfg),h.$el.appendTo("body"))}}),a.define("component.Director",b)}(crafter.social),function(a){"use strict";var b=window.CKEDITOR;a.define("Editor",b,"social.Editor"),b.basePath=a.resource("libs/ckeditor/"),b.plugins.basePath=a.resource("libs/ckeditor/"),b.config.customConfig=a.resource("scripts/component/ckeditor/config.js")}(crafter.social),function(a){"use strict";var b=a.window,c=b.Handlebars,d=a.util;a.define("TemplateEngine",c,"social.TemplateEngine"),c.registerHelper("html",function(a){return new c.SafeString(a)}),c.registerHelper("content-type",function(a){var b={"image/png":"Image (PNG)","image/jpeg":"Image (JPEG)","application/pdf":"PDF Document","text/plain":"Plain Text File","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"Microsoft Excel Spreadsheet","application/msword":"Microsoft Word Document","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"Microsoft Word Document","image/vnd.adobe.photoshop":"Photoshop File","application/zip":"Zip File","application/xml":"XML File"}[a]||a;return new c.SafeString(b)}),c.registerHelper("eq",function(a,b,c){return a===b?c.fn(this):c.inverse(this)}),c.registerHelper("gt",function(a,b,c){return a>b?c.fn(this):c.inverse(this)}),c.registerHelper("lt",function(a,b,c){return b>a?c.fn(this):c.inverse(this)}),c.registerHelper("ifm",function(a,b){return a.call()?b.fn(this):b.inverse(this)}),c.registerHelper("mif",function(a,b,c,e){switch(d.isFunction(a)&&(a=a.call(this)),d.isFunction(c)&&(c=c.call(this)),b){case"has":case"contains":return d.contains(a,c)?e.fn(this):e.inverse(this);case"||":case"or":return a||c?e.fn(this):e.inverse(this);case"gt":case">":return a>c?e.fn(this):e.inverse(this);case"lt":case"<":return c>a?e.fn(this):e.inverse(this);case"&&":case"and":return a&&c?e.fn(this):e.inverse(this)}}),c.registerHelper("munless",function(a,b,c){d.isFunction(a)&&(a=a.call(this)),d.isFunction(c)&&(c=c.call(this))}),c.registerHelper("ternary",function(a,b,e){return d.isFunction(a)&&(a=a.call(this)),new c.SafeString(a?b:e)}),c.registerHelper("multiplicity",function(a,b,d,e){var f=(0===a?e:a>1?b:d).fmt(a);return new c.SafeString(f)}),c.registerHelper("minusOne",function(a){return new c.SafeString(--a)}),c.registerHelper("round",function(a){return new c.SafeString(Math.round(a))}),c.registerHelper("divide",function(a,b){return new c.SafeString(Math.round(a/b))}),c.registerHelper("date",function(a){var b,d=new Date(a),e=(b||"{month} {date}, {year}").fmt({month:"months.%@".fmt(d.getMonth()).loc(),day:"days.%@".fmt(d.getDay()).loc(),date:d.getDate(),year:d.getFullYear()});return new c.SafeString(e)}),c.registerHelper("loc",function(a){return new c.SafeString(a.loc())}),c.registerHelper("formatFileSize",function(a){return"number"!=typeof a?"":a>=1e9?(a/1e9).toFixed(2)+" GB":a>=1e6?(a/1e6).toFixed(2)+" MB":(a/1e3).toFixed(2)+" KB"}),c.registerHelper("log",function(){console&&console.log&&console.log(this)}),a.noConflict("Handlebars")}(crafter.social),function(a){"use strict";var b=a.$,c=a.TemplateEngine.compile;b.blueimp.fileupload.prototype._specialOptions.push("filesContainer","uploadTemplateId","downloadTemplateId"),b.widget("blueimp.fileupload",b.blueimp.fileupload,{options:{autoUpload:!1,uploadTemplateId:"template-upload",downloadTemplateId:"template-download",filesContainer:void 0,prependFiles:!1,dataType:"json",getNumberOfFiles:function(){return this.filesContainer.children().not(".processing").length},getFilesFromResponse:function(a){return a.result&&b.isArray(a.result.files)?a.result.files:[]},add:function(a,c){if(a.isDefaultPrevented())return!1;var d=b(this),e=d.data("blueimp-fileupload")||d.data("fileupload"),f=e.options;c.context=e._renderUpload(c.files).data("data",c).addClass("processing"),f.filesContainer[f.prependFiles?"prepend":"append"](c.context),e._forceReflow(c.context),b.when(e._transition(c.context),c.process(function(){return d.fileupload("process",c)})).always(function(){c.context.each(function(a){b(this).find(".size").text(e._formatFileSize(c.files[a].size))}).removeClass("processing"),e._renderPreviews(c)}).done(function(){c.context.find(".start").prop("disabled",!1),e._trigger("added",a,c)!==!1&&(f.autoUpload||c.autoUpload)&&c.autoUpload!==!1&&c.submit()}).fail(function(){c.files.error&&c.context.each(function(a){var d=c.files[a].error;d&&b(this).find(".error").text(d)})})},send:function(a,c){if(a.isDefaultPrevented())return!1;var d=b(this).data("blueimp-fileupload")||b(this).data("fileupload");return c.context&&c.dataType&&"iframe"===c.dataType.substr(0,6)&&c.context.find(".progress").addClass(!b.support.transition&&"progress-animated").attr("aria-valuenow",100).children().first().css("width","100%"),d._trigger("sent",a,c)},done:function(a,c){if(a.isDefaultPrevented())return!1;var d,e,f=b(this).data("blueimp-fileupload")||b(this).data("fileupload"),g=c.getFilesFromResponse||f.options.getFilesFromResponse,h=g(c);c.context?c.context.each(function(g){var i=h[g]||{error:"Empty file upload result"};e=f._addFinishedDeferreds(),f._transition(b(this)).done(function(){var g,h=b(this);try{var j=JSON.parse(c.xhr().responseText);g=[b.extend({},i,j)]}catch(k){g=[i]}d=f._renderDownload(g).replaceAll(h),f._forceReflow(d),f._transition(d).done(function(){c.context=b(this),f._trigger("completed",a,c),f._trigger("finished",a,c),e.resolve()})})}):(d=f._renderDownload(h)[f.options.prependFiles?"prependTo":"appendTo"](f.options.filesContainer),f._forceReflow(d),e=f._addFinishedDeferreds(),f._transition(d).done(function(){c.context=b(this),f._trigger("completed",a,c),f._trigger("finished",a,c),e.resolve()}))},fail:function(a,c){if(a.isDefaultPrevented())return!1;var d,e,f=b(this).data("blueimp-fileupload")||b(this).data("fileupload");c.context?c.context.each(function(g){if("abort"!==c.errorThrown){var h=c.files[g];try{var i=c.xhr(),j=JSON.parse(i.responseText);h.error=j.localizedMessage||j.message}catch(k){h.error=h.error||c.errorThrown||!0}e=f._addFinishedDeferreds(),f._transition(b(this)).done(function(){var g=b(this);d=f._renderDownload([h]).replaceAll(g),f._forceReflow(d),f._transition(d).done(function(){c.context=b(this),f._trigger("failed",a,c),f._trigger("finished",a,c),e.resolve()})})}else e=f._addFinishedDeferreds(),f._transition(b(this)).done(function(){b(this).remove(),f._trigger("failed",a,c),f._trigger("finished",a,c),e.resolve()})}):"abort"!==c.errorThrown?(c.context=f._renderUpload(c.files)[f.options.prependFiles?"prependTo":"appendTo"](f.options.filesContainer).data("data",c),f._forceReflow(c.context),e=f._addFinishedDeferreds(),f._transition(c.context).done(function(){c.context=b(this),f._trigger("failed",a,c),f._trigger("finished",a,c),e.resolve()})):(f._trigger("failed",a,c),f._trigger("finished",a,c),f._addFinishedDeferreds().resolve())},progress:function(a,c){if(a.isDefaultPrevented())return!1;var d=Math.floor(c.loaded/c.total*100);c.context&&c.context.each(function(){b(this).find(".progress").attr("aria-valuenow",d).children().first().css("width",d+"%")})},progressall:function(a,c){if(a.isDefaultPrevented())return!1;var d=b(this),e=Math.floor(c.loaded/c.total*100),f=d.find(".fileupload-progress"),g=f.find(".progress-extended");g.length&&g.html((d.data("blueimp-fileupload")||d.data("fileupload"))._renderExtendedProgress(c)),f.find(".progress").attr("aria-valuenow",e).children().first().css("width",e+"%")},start:function(a){if(a.isDefaultPrevented())return!1;var c=b(this).data("blueimp-fileupload")||b(this).data("fileupload");c._resetFinishedDeferreds(),c._transition(b(this).find(".fileupload-progress")).done(function(){c._trigger("started",a)})},stop:function(a){if(a.isDefaultPrevented())return!1;var c=b(this).data("blueimp-fileupload")||b(this).data("fileupload"),d=c._addFinishedDeferreds();b.when.apply(b,c._getFinishedDeferreds()).done(function(){c._trigger("stopped",a)}),c._transition(b(this).find(".fileupload-progress")).done(function(){b(this).find(".progress").attr("aria-valuenow","0").children().first().css("width","0%"),b(this).find(".progress-extended").html("&nbsp;"),d.resolve()})},processstart:function(a){return a.isDefaultPrevented()?!1:void b(this).addClass("fileupload-processing")},processstop:function(a){function c(){var a=window.navigator.userAgent,b=a.indexOf("MSIE ");return b>0||navigator.userAgent.match(/Trident.*rv\:11\./)?!0:!1}function d(){var a=window.navigator.userAgent,b=a.indexOf("MSIE ");return b>0||navigator.userAgent.match(/Trident.*rv\:11\./)?parseInt(a.substring(b+5,a.indexOf(".",b))):-1}if(a.isDefaultPrevented())return!1;if(b(this).removeClass("fileupload-processing"),c()&&d()<10){var e=b(this);e.find(".cs-file-data, .cs-file-upload, .btn.cancel").remove()}},destroy:function(a,c){if(a.isDefaultPrevented())return!1;var d=b(this).data("blueimp-fileupload")||b(this).data("fileupload"),e=function(){d._transition(c.context).done(function(){b(this).remove(),d._trigger("destroyed",a,c)})};c.url?(c.dataType=c.dataType||d.options.dataType,b.ajax(c).done(e).fail(function(){d._trigger("destroyfailed",a,c)})):e()}},_resetFinishedDeferreds:function(){this._finishedUploads=[]},_addFinishedDeferreds:function(a){return a||(a=b.Deferred()),this._finishedUploads.push(a),a},_getFinishedDeferreds:function(){return this._finishedUploads},_enableDragToDesktop:function(){var a=b(this),c=a.prop("href"),d=a.prop("download"),e="application/octet-stream";a.bind("dragstart",function(a){try{a.originalEvent.dataTransfer.setData("DownloadURL",[e,d,c].join(":"))}catch(b){}})},_formatFileSize:function(a){return"number"!=typeof a?"":a>=1e9?(a/1e9).toFixed(2)+" GB":a>=1e6?(a/1e6).toFixed(2)+" MB":(a/1e3).toFixed(2)+" KB"},_formatBitrate:function(a){return"number"!=typeof a?"":a>=1e9?(a/1e9).toFixed(2)+" Gbit/s":a>=1e6?(a/1e6).toFixed(2)+" Mbit/s":a>=1e3?(a/1e3).toFixed(2)+" kbit/s":a.toFixed(2)+" bit/s"},_formatTime:function(a){var b=new Date(1e3*a),c=Math.floor(a/86400);return c=c?c+"d ":"",c+("0"+b.getUTCHours()).slice(-2)+":"+("0"+b.getUTCMinutes()).slice(-2)+":"+("0"+b.getUTCSeconds()).slice(-2)},_formatPercentage:function(a){return(100*a).toFixed(2)+" %"},_renderExtendedProgress:function(a){return this._formatBitrate(a.bitrate)+" | "+this._formatTime(8*(a.total-a.loaded)/a.bitrate)+" | "+this._formatPercentage(a.loaded/a.total)+" | "+this._formatFileSize(a.loaded)+" / "+this._formatFileSize(a.total)},_renderTemplate:function(a,c){if(!a)return b();var d=a({files:c,formatFileSize:this._formatFileSize,options:this.options});return d instanceof b?d:b(this.options.templatesContainer).html(d).children()},_renderPreviews:function(a){a.context.find(".preview").each(function(c,d){b(d).append(a.files[c].preview)})},_renderUpload:function(a){return this._renderTemplate(this.options.uploadTemplate,a)},_renderDownload:function(b){for(var c=a.get("model.File"),d=[],e=0,f=b.length,g=new c;f>e;e++)d.push(g.parse(b[e]));return this._renderTemplate(this.options.downloadTemplate,d).find("a[download]").each(this._enableDragToDesktop).end()},_startHandler:function(a){a.preventDefault();var c=b(a.currentTarget),d=c.closest(".crafter-social-template-upload"),e=d.data("data");c.prop("disabled",!0),e&&e.submit&&e.submit()},_cancelHandler:function(a){a.preventDefault();var c=b(a.currentTarget).closest(".crafter-social-template-upload,.template-download"),d=c.data("data")||{};d.context=d.context||c,d.abort?d.abort():(d.errorThrown="abort",this._trigger("fail",a,d))},_deleteHandler:function(a){a.preventDefault();var c=b(a.currentTarget);this._trigger("destroy",a,b.extend({context:c.closest(".template-download"),type:"DELETE"},c.data()))},_forceReflow:function(a){return b.support.transition&&a.length&&a[0].offsetWidth},_transition:function(a){var c=b.Deferred();return b.support.transition&&a.hasClass("fade")&&a.is(":visible")?a.bind(b.support.transition.end,function(d){d.target===a[0]&&(a.unbind(b.support.transition.end),c.resolveWith(a))}).toggleClass("in"):(a.toggleClass("in"),c.resolveWith(a)),c},_initButtonBarEventHandlers:function(){var a=this.element.find(".fileupload-buttonbar"),c=this.options.filesContainer;this._on(a.find(".start"),{click:function(a){a.preventDefault(),c.find(".start").click()}}),this._on(a.find(".cancel"),{click:function(a){a.preventDefault(),c.find(".cancel").click()}}),this._on(a.find(".delete"),{click:function(b){b.preventDefault(),c.find(".toggle:checked").closest(".template-download").find(".delete").click(),a.find(".toggle").prop("checked",!1)}}),this._on(a.find(".toggle"),{change:function(a){c.find(".toggle").prop("checked",b(a.currentTarget).is(":checked"))}})},_destroyButtonBarEventHandlers:function(){this._off(this.element.find(".fileupload-buttonbar").find(".start, .cancel, .delete"),"click"),this._off(this.element.find(".fileupload-buttonbar .toggle"),"change.")},_initEventHandlers:function(){this._super(),this._on(this.options.filesContainer,{"click .start":this._startHandler,"click .cancel":this._cancelHandler,"click .delete":this._deleteHandler}),this._initButtonBarEventHandlers()},_destroyEventHandlers:function(){this._destroyButtonBarEventHandlers(),this._off(this.options.filesContainer,"click"),this._super()},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!1).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!0).parent().addClass("disabled")},_initTemplates:function(){var a=this.options;a.templatesContainer=this.document[0].createElement(a.filesContainer.prop("nodeName")),a.uploadTemplateId&&(a.uploadTemplate=c(document.getElementById(a.uploadTemplateId).innerHTML)),a.downloadTemplateId&&(a.downloadTemplate=c(document.getElementById(a.downloadTemplateId).innerHTML))},_initFilesContainer:function(){var a=this.options;void 0===a.filesContainer?a.filesContainer=this.element.find(".cs-files-list"):a.filesContainer instanceof b||(a.filesContainer=b(a.filesContainer))},_initSpecialOptions:function(){if(this._super(),this._initFilesContainer(),this._initTemplates(),!function(){return-1!==["undefined"!=typeof window.FileReader,"draggable"in document.createElement("span"),!!window.FormData,"upload"in new XMLHttpRequest].join(" ").indexOf("false")}()){var a=b(this.element).parent();this.__dragenter=function(){a.addClass("dropbox-dragover")},this.__dragleave=function(){a.removeClass("dropbox-dragover")},b(document).bind("dragover dragenter",this.__dragenter).bind("dragleave drop",this.__dragleave),a.parent().prepend('<div style="margin-bottom: 10px; text-align: center"><i class="crafter-social-icon cs-icon-info-sign"></i> You may drag and drop files from your desktop to upload them.</div>')}},__dragenter:b.noop,__dragleave:b.noop,_create:function(){this._super(),this._resetFinishedDeferreds(),b.support.fileInput||this._disableFileInputButton()},_destroy:function(){this._destroyEventHandlers(),b(document).unbind("dragover dragenter",this.__dragenter).unbind("dragleave drop",this.__dragleave)},enable:function(){var a=!1;this.options.disabled&&(a=!0),this._super(),a&&(this.element.find("input, button").prop("disabled",!1),this._enableFileInputButton())},disable:function(){this.options.disabled||(this.element.find("input, button").prop("disabled",!0),this._disableFileInputButton()),this._super()}})}(crafter.social),function(a){"use strict";var b=a.$,c=a.Constants,d=a.Backbone.Model.extend({idAttribute:"id",defaults:{username:"anonymous"},url:function(){this.isNew()},parse:function(a){return a?a.profile:void 0},authenticate:function(){return this.fetch({type:"POST",url:a.url("security"),data:b.param(this.toJSON()),success:function(b){a.getDirector().trigger(c.get("EVENT_USER_AUTHENTICATION_SUCCESS"),b)},error:function(){a.getDirector().trigger(c.get("EVENT_USER_AUTHENTICATION_FAILED"))}})},getFromSession:function(){var d,e={},f=this;return d=e.xhr=b.ajax({type:"GET",cache:!1,url:a.url("security.active"),success:function(b){204===d.status?a.getDirector().trigger(c.get("EVENT_USER_NOT_AUTHENTICATED")):(f.set(f.parse(b,e)),f.trigger("sync",f,b,e),a.getDirector().trigger(c.get("EVENT_USER_AUTHENTICATION_SUCCESS"),f))}}),this.trigger("request",f,d,e),d},hasRole:function(a,b){var c=!1,d=this.get("attributes");if(d){var e=d.socialContexts;if(e)for(var f=0;f<e.length;f++){var g=e[f];if(g.id===b){for(var h=g.roles,i=0;i<h.length;i++)if(h[i]===a){c=!0;break}if(c)break}}}return c}});a.define("model.Profile",d)}(crafter.social),function(a){"use strict";var b=a.Backbone.Model.extend({idAttribute:"attachmentId",downloadUrl:function(){return"/"},url:function(){return this.isNew()?a.url("comments.{_id}.attachments"):void 0},parse:function(b){try{b.url=a.url("comments.{_id}.attachments.{fileId}",{_id:b.attributes.owner,fileId:b.fileId,context:"f5b143c2-f1c0-4a10-b56e-f485f00d3fe9"})}catch(c){console&&console.log("crafter.social.model.File: ",c)}return b},detach:function(){},open:function(){}});a.define("model.File",b)}(crafter.social),function(a){"use strict";function b(b,c,d,f,g){g||(g={});var h={type:d||"POST",url:a.url(b,e.extend({},this.toJSON()||{},f)),success:g.success,error:g.error};return c&&(h.data=e.param(c)),this.save(null,h)}var c=a.Constants,d=a.Backbone.Model,e=a.$,f=d.extend({idAttribute:"_id",defaults:{ancestors:[],body:"",thread:"",children:[],attributes:{},createdDate:Date.now(),attachments:[]},hasChildren:function(){return this.get("children").length>0},isReply:function(){return this.get("ancestors").length>0},url:function(){return a.url(this.isNew()?"comments":"comments.{_id}",this.toJSON())},isTrashed:function(){return this.get("moderationStatus")===c.get("MODERATION_STATUS_TRASH")},voteUp:function(a){b.call(this,"comments.{_id}.votes.up",a)},voteDown:function(a){b.call(this,"comments.{_id}.votes.down",a)},removeVote:function(a){b.call(this,"comments.{_id}.votes.neutral",a)},flag:function(a){b.call(this,"comments.{_id}.flags",a)},unflag:function(a){var c=this.flagId(a.profileId);c&&(this.get("flags").splice(c.index,1),b.call(this,"comments.{_id}.flags.{flagId}",a,"POST",{
flagId:c.id}))},flagId:function(a){var b,c=this.attributes.flags,d=c.length;for(b=0;d>b;++b)if(c[b].userId===a)return{id:c[b]._id,index:b};return null},flaggedBy:function(a){if(void 0===a)return!1;var b,c=this.attributes.flags,d=c.length;for(b=0;d>b;++b)if(c[b].userId===a)return!0;return!1},trash:function(a){this.moderate(c.get("MODERATION_STATUS_TRASH"),a)},moderate:function(a,c){b.call(this,"comments.{_id}.moderate",e.extend({},c||{},{status:a}),"POST",{context:c.context})},update:function(a,c){b.call(this,"comments.{_id}.update",{id:"",body:this.get("body")},"POST",{context:a.context},c)},reply:function(a,b){var c=this.attributes,d=c.ancestors.slice();d.push(c);var e={body:a.body,parent:c._id,dateAdded:Date.now(),thread:c.targetId,context:a.context,targetId:c.targetId,attributes:{commentUrl:c.attributes.commentUrl,commentThreadName:c.attributes.commentThreadName}};this.collection.create(e,b)},fetch:function(a){return a=a||{},a.cache=!1,Backbone.Collection.prototype.fetch.call(this,a)}});a.define("model.Comment",f)}(crafter.social),function(a){"use strict";var b=a.$,c=a.util,d=a.Backbone,e=d.Collection.extend({model:a.model.Comment,isWatched:!1,create:function(a,c){var e=new FormData,f=a.toJSON?a.toJSON():a;return b.each(f,function(a,b){e.append(a,"attributes"===a?JSON.stringify(b):b)}),d.Collection.prototype.create.call(this,a,b.extend({data:e,contentType:!1},c||{}))},initialize:function(a,b){this.guid=c.guid(),this.extendCfg(this.constructor.DEFAULTS,b)},extendCfg:function(a,c){return this.cfg||(this.cfg={}),b.extend(!0,this.cfg,a,c)},url:function(){return a.url("threads.{target}.comments",this.cfg)},parse:function(a){var b=a.comments||a;return this.setIsWatched(a.watched||!1),b},getGUID:function(){return this.guid},setIsWatched:function(b){this.isWatched=b,this.trigger(a.Constants.get("EVENT_DISCUSSION_WATCHED",this.cfg),b)},getIsWatched:function(){return this.isWatched}});e.DEFAULTS={context:null,target:null},a.define("controller.Base",e)}(crafter.social),function(a){"use strict";var b=a.controller.Base,c=b.extend({model:a.model.File,url:function(){return a.url("comments.{_id}.attachments",{_id:this.cfg.comment.get("_id")})},parse:function(a){return a}});c.DEFAULTS={},a.define("controller.Files",c)}(crafter.social),function(a){"use strict";var b=0,c=a.util,d=a.$,e=a.Backbone.View.extend({className:"crafter-social-view",initialize:function(a){this.cache("initialised")||(this.guid=c.guid(),this.extendCfg(this.constructor.DEFAULTS,a||{}),this.cfg.classes&&this.$el.addClass(c.isArray(this.cfg.classes)?this.cfg.classes.join(" "):this.cfg.classes),this.delegateActions(this,this.element()),this.listen&&this.listen(),this.createUI&&this.createUI(),this.events&&(this.events=this.parseEvents()),this.handleIdentifyRequests(),this.cache("initialised",!0))},listen:function(){},delegateActions:function(a,b){b.delegate("[data-action]","click",function(b){b.preventDefault(),b.stopImmediatePropagation(),b.stopPropagation();var c=d(this).data("action");if(""!==c){var e=c.match(/\(([\s\S]+?)\)/)||[];e.length&&(e=e[1].split(",")),e.splice(0,0,b),c=c.replace(/\(([\s\S]+?)\)/,""),a[c]&&a[c].apply(a,e)}})},extendCfg:function(a,b){return!this.cfg&&(this.cfg={}),d.extend(!0,this.cfg,a,b)},parseEvents:function(a){var b={};return a=d.extend(a||{},{guid:this.guid}),this.events&&d.each(this.events,function(c,d){var e=c.fmt(a.guid).fmt(a);b[e]=d}),b},handleIdentifyRequests:function(){var a=this;this.$("[data-indentifyme]").each(function(){a.identify(this,d(this).data("indentifyme")),d(this).removeAttr("data-indentifyme")})},cmpID:function(a,b){return 1===arguments.length&&(b=!0),"%@%@_%@".fmt(b?"#":"",a,this.guid)},identify:function(a,c){d(a).attr({id:this.cmpID(c||"elem"+b++,!1)})},createUI:function(){this.cache("created")||(this.element().html(this.getTemplate("main")),this.cache("created",!0))},element:function(){return this.$el},getTemplate:function(b){var d,e='id="$1_'+this.guid+'"',g=this.cfg.templates[b];"function"==typeof g&&(g=g.call(this,b));var i=h.get(g);return"undefined"==typeof g||null===g?d="":c.isHTML(g)?d=g:null!==i?d=i:a.request({async:!1,url:g,success:function(a){d=a,h.set(g,d)},error:function(){throw new Error('Failed to load template "%@"'.fmt(g))}}),d.replace(f,e)},cache:function(b,c){return!g[this.guid]&&(g[this.guid]={}),arguments.length>1?(c===a.Constants.get("DESTROY")?delete g[this.guid][b]:g[this.guid][b]=c,!0):g[this.guid][b]}}),f=/data-identifyme="(.*?)"/g;e.DEFAULTS={};var g={},h={cache:{},set:function(a,b){return this.cache[a]=b,!0},get:function(a){return this.cache[a]||null}};a.define("view.Base",e)}(crafter.social),function(a){"use strict";if(!a.$.fn.modal)throw new Error("Modal requires bootstrap modal");var b,c=a.view.Base,d=a.util,e=a.$,f=e.extend({},e.fn.modal.Constructor.prototype,{className:[c.prototype.className,"crafter-social-modal-view","fade"].join(" "),initialize:function(){c.prototype.initialize.apply(this,arguments),this.initModal()},listen:function(){c.prototype.listen.call(this);var a=this;this.$el.on("shown.bs.modal",function(){a.trigger("shown")}),this.$el.on("hidden.bs.modal",function(){a.trigger("hidden")}),this.listenTo(this,"shown",function(){e("body, html").css("overflow","hidden")}),this.listenTo(this,"hidden",function(){e("body, html").css("overflow","")})},initModal:function(){var a=e(this.el),b=a.data("bs.modal");!b&&a.data("bs.modal",this),this.options=this.cfg.modal,this.$element=a,this.$backdrop=this.isShown=null,this.options.remote&&this.$element.load(this.options.remote)},backdrop:function(){e.fn.modal.Constructor.prototype.backdrop.apply(this,arguments),this.$backdrop&&this.$backdrop.removeClass("modal-backdrop").addClass("crafter-social-modal-view-backdrop")},render:function(){return this.cfg.modal.show&&this.show(),this},set:function(a,b){if(1===arguments.length){var c=this,f=a;e.each(f,function(a,b){c.set(a,b)})}var g=this.$({header:".modal-header",title:".modal-title",body:".modal-body",footer:".modal-footer"}[a]);"object"==typeof b&&("nodeType"in b||b instanceof e)?g.html("").append(b):d.isHTML(b)?g.html(b):g.text(b)},destroy:function(){this.trigger("hidden"),this.$el.remove(),this.$backdrop&&this.$backdrop.remove()}});delete f.constructor,b=c.extend(f),b.DEFAULTS=e.extend({},{templates:{main:"%@modal.hbs".fmt(a.Cfg("url.templates"))},modal:e.extend({},e.fn.modal.Constructor.DEFAULTS,{backdrop:!0,keyboard:!0,show:!1,remote:!1})}),a.define("view.Modal",b)}(crafter.social),function(a){"use strict";var b=a.view.Base,c=a.model.Comment,d=a.util,e=a.$,f=a.getDirector(),g=b.extend({className:[b.prototype.className,"crafter-social-comment"].join(" "),createUI:d.emptyFn,events:{"click [data-action-reply]":"reply","click [data-action-flag]":"flag"},initialize:function(a){b.prototype.initialize.apply(this,arguments),this.model.collection=this.model.collection||a.collection},listen:function(){this.model&&(this.listenTo(this.model,"sync",this.render),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"remove",this.remove))},render:function(){var b=this,h=f.getProfile(),i=e.extend(this.model.toJSON(),{sessionUserId:h.id,isTrashed:function(){return b.model.isTrashed()},isAdmin:function(){return h.hasRole("SOCIAL_ADMIN")},isModerator:function(){return h.hasRole("SOCIAL_MODERATOR")},isOwner:function(){return i.createdBy===h.id},isLogged:function(){return void 0!==h&&void 0!==h.id},avatarUrl:function(){var c=b.model.ts;return void 0!==i.reloadAvatar&&(c=i.reloadAvatar),a.url("profile.avatar",{id:i.user?i.user.id:h.id,context:b.cfg.context,ts:c})}});this.$el.html(d.template(this.getTemplate("main"),i));var j=this.$(".comment-children:first");this.$(".change-avatar").mouseleave(function(){i.createdBy===h.id&&(b.$(".change-avatar").addClass("hidden"),b.$(".current-avatar").removeClass("hidden"))}),this.$(".current-avatar").mouseover(function(){i.createdBy===h.id&&(b.$(".current-avatar").addClass("hidden"),b.$(".change-avatar").removeClass("hidden"))});var k=this.$(".comment-attachments:first");return i.children.every(function(a){var d=new c(a),f=new g(e.extend({},b.cfg,{model:d}));return j.append(f.render().el),!0}),i.attachments.every(function(b){var c=a.get("model.File"),d=new c;if(d=d.parse(b),d.fileName.match(/\.(jpg|jpeg|png|gif)$/)){var e='<img class="img-thumbnail img-file" data-action="viewFile" title="'+d.fileName+'" alt="'+d.fileName+'" src="'+d.url+'" />';k.append(e)}return!0}),this},voteUp:function(a){a.preventDefault();var b=this.getRequestParams();this.model.voteUp(b)},voteDown:function(){var a=this.getRequestParams();this.model.voteDown(a)},uploadAvatar:function(){var b=this,c=[],d=a.util.instance("view.Modal",{modal:{show:!0},events:{"change input[type=file]":function(a){c=a.target.files},"click .btn-primary":function(){var g=new FormData;e.each(c,function(a,b){g.append(a,b)}),a.request({type:"POST",cache:!1,contentType:!1,processData:!1,data:g,url:a.url("profile.avatar",{_id:f.getProfile().id,context:b.cfg.context}),success:function(){d.hide(),b.model.collection.each(function(a){a.get("user").id===f.getProfile().id&&a.set("reloadAvatar",(new Date).getTime())})},error:function(){d.$(".modal-body").prepend('<div class="alert alert-danger">Unable to Upload profile image</div>')}})}}});d.set({title:"Upload Profile Image",body:'<div class="form-group"><p>If you choose to upload a photo please select a current business relevant photo of yourself.</p><br/><input id="avatarFileupload" type="file" name="avatar" value="Choose new profile picture"><br/><div id="progress"><div class="bar" style="width: 0%;"></div></div>     </div>',footer:'<button class="btn btn-primary">Upload</button>'}),d.render()},removeVote:function(){var a=this.getRequestParams();this.model.removeVote(a)},edit:function(a){var b=this.$(".comment-data").addClass("editing"),c=b.find(".editor");c.html(b.find(".content-wrapper").html()),c.attr("contenteditable","true");var d=CKEDITOR.inline(c.get(0),{startupFocus:!0,toolbar:"Basic"});this.cache("editor",d)},cancelEdit:function(b){this.cache("editor")&&(this.cache("editor").destroy(),this.cache("editor",a.Constants.get("DESTROY")),this.$(".comment-data").removeClass("editing").find(".editor").html(""))},doEdit:function(b){var c;if(c=this.cache("editor")){var d=this,e=c.getData();if(!e)return;this.model.set("body",e),this.model.update(this.getRequestParams(),{success:function(){c.destroy(),d.cache("editor",a.Constants.get("DESTROY"))}})}},reply:function(a){a.preventDefault(),a.stopPropagation();var b=this.$(".comment-body-reply:first").addClass("replying"),c=b.find(".editor");c.html(b.find(".content-wrapper").html()),c.attr("contenteditable","true");var d=CKEDITOR.inline(c.get(0),{startupFocus:!0,toolbar:"Basic"});this.cache("editor",d)},cancelReply:function(b){this.cache("editor")&&(this.cache("editor").destroy(),this.cache("editor",a.Constants.get("DESTROY")),this.$(".comment-body-reply").removeClass("replying").find(".editor").html(""))},doReply:function(b){var c;if(c=this.cache("editor")){var d=this,e=c.getData();e&&this.model.reply(this.getRequestParams({body:e}),{success:function(){c.destroy(),d.cache("editor",a.Constants.get("DESTROY")),d.collection.fetch({data:{target:d.cfg.target,context:d.cfg.context}})},error:function(a){c.setData("<div>"+a.get("body")+"</div>"+c.getData());var b=c.createRange();b.moveToPosition(b.root,CKEDITOR.POSITION_BEFORE_END),c.getSelection().selectRanges([b]),collection.remove(a)}})}},flag:function(b){b.preventDefault();var c=this,d=this.model.flaggedBy(f.getProfile().get("id")),e=a.util.instance("view.Modal",{modal:{show:!0},events:{"click .btn-primary":function(){this.$(".alert").remove();var a=this.$("textarea").val().trim();""!==a?(c.model[d?"unflag":"flag"](c.getRequestParams({reason:a,profileId:f.getProfile().get("id")})),this.destroy()):this.$(".modal-body").prepend('<div class="alert alert-danger">Please provide the reason.</div>').find("textarea").focus()}}});e.set({title:d?"Discard Comment Flag":"Flag Comment",body:(d?"<p>You previously flagged this comment. This form allows you to retreat your flag.</p>":"")+'<div class="form-group"><label>Reason</label><textarea class="form-control"></textarea></div>',footer:'<button class="btn btn-primary">Submit</button>'}),e.render()},unflag:function(a){this.model.unflag(a)},trash:function(){this.model.isTrashed()||(this.model.trash(this.getRequestParams()),this.$el.remove())},_dragOverFn:function(a){a.preventDefault()},getRequestParams:function(a){return e.extend({context:this.cfg.context},a||{})},files:function(){var b=this,c=this.model,d=a.util.instance("controller.Files",null,{comment:c}),e=a.util.instance("view.Files",{collection:d});e.render();var f=a.get("view.Modal"),g=new f({modal:{show:!0,keyboard:!1,backdrop:"static"}}),h={data:{context:this.cfg.context}};g.$el.on("hidden.bs.modal",function(){b.model.fetch(h),g.uploader&&g.uploader.fileupload("destroy"),g.destroy()});var i=a.url("comments.{_id}.attachments",c.toJSON(),h.data);g.$el.on("shown.bs.modal",function(){(g.uploader=e.$("#fileupload")).fileupload({autoUpload:!0,dataType:"json",singleFileUploads:!0,url:i,xhrFields:{withCredentials:!0},paramName:"attachment",uploadPostKey:"attachment",formData:h.data,getFilesFromResponse:function(a){return a.files||[]}}).attr("action",i).bind("fileuploadfinished",function(){b.model.fetch(h)})}),g.set("title","File Attachments"),g.set("body",e.el),g.set("footer",'<button class="btn btn-default" data-dismiss="modal">Close</button>'),g.render(),d.fetch(h)},viewFile:function(b){var c=a.get("view.Modal"),d=new c({modal:{show:!0,keyboard:!1,backdrop:"static"}});d.set("body",'<img class="img-file" src="'+b.target.src+'"/>'),d.set("footer",'<button class="btn btn-default" data-dismiss="modal">Close</button>'),d.render()},remove:function(){this.trigger("remove",this.model),this.$el.remove()}});g.DEFAULTS=e.extend(!0,{},b.DEFAULTS,{templates:{main:"%@comment.hbs".fmt(a.Cfg("url.templates"))},commenting:{templates:{main:function(){return"%@commenting.hbs".fmt(a.Cfg("url.templates"))}},editor:{extraPlugins:"",toolbar:"Full",height:800}}}),a.define("view.Comment",g)}(crafter.social),function(a){"use strict";var b,c=a.view.Base,d=a.Editor,e=a.$;b=c.extend({className:[c.prototype.className,"crafter-social-commenting-view"].join(" "),events:{"click [data-action-comment]":"comment"},editor:function(b){var c=this.cache("editor");if("destroy"===b)return void(c&&(c.destroy(),this.cache("editor",a.Constants.get("DESTROY"))));if(!c){var f=this;if(c=f.cache("editor"),!c){var g=f.cfg.editorMode,h=f.$(".textarea:first"),i=h.find("textarea:first");h.addClass("editor-mode-"+g),c=d[g](i.get(0),e.extend({on:{pluginsLoaded:function(){this.addCommand("_enterpressed_",{exec:function(){f.comment()}}),this.keystrokeHandler.keystrokes[d.SHIFT+13]="_enterpressed_"}}},f.cfg.editor)),f.cache("editor",c)}}return c},comment:function(){var a=this.editor(),b=e(this.el).find("[data-action-terms]"),c=a.getData();if(c&&b.is(":checked")){var f={body:c,dateAdded:Date.now(),thread:this.cfg.target,context:this.cfg.context,attributes:{}},g=this.collection;g.create(f,{error:function(b){a.setData("<div>"+b.get("body")+"</div>"+a.getData());var c=a.createRange();c.moveToPosition(c.root,d.POSITION_BEFORE_END),a.getSelection().selectRanges([c]),g.remove(b)}}),a.setData("")}},render:function(){return this.editor(),this}}),b.DEFAULTS=e.extend({},c.DEFAULTS,{templates:{main:function(){return"%@commenting.hbs".fmt(a.Cfg("url.templates"))}},editorMode:"replace",editor:{autoGrow_bottomSpace:0,autoGrow_maxHeight:800,autoGrow_minHeight:0,autoGrow_onStartup:!1,autoParagraph:!0,autoUpdateElement:!0,baseFloatZIndex:1e4,baseHref:"",basicEntities:!0,blockedKeystrokes:[d.CTRL+66,d.CTRL+73,d.CTRL+85],bodyClass:"",bodyId:"",browserContextMenuOnCtrl:!0,colorButton_backStyle:{element:"span",styles:{"background-color":"#(color)"}},colorButton_colors:"000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF",colorButton_enableMore:!0,colorButton_foreStyle:{element:"span",styles:{color:"#(color)"}},contentsCss:a.Cfg("url.base")+"styles/editor-content.css",contentsLangDirection:"ui",contentsLanguage:"en",corePlugins:"",coreStyles_bold:{element:"strong",overrides:"b"},coreStyles_italic:{element:"em",overrides:"i"},coreStyles_strike:{element:"strike"},coreStyles_subscript:{element:"sub"},coreStyles_superscript:{element:"sup"},coreStyles_underline:{element:"u"},customConfig:"",defaultLanguage:"en",devtools_styles:["#cke_tooltip { padding: 5px; border: 2px solid #333; background: #ffffff }","#cke_tooltip h2 { font-size: 1.1em; border-bottom: 1px solid; margin: 0; padding: 1px; }","#cke_tooltip ul { padding: 0pt; list-style-type: none; }"].join(""),dialog_backgroundCoverColor:"white",dialog_backgroundCoverOpacity:.5,dialog_buttonsOrder:"OS",dialog_magnetDistance:20,dialog_startupFocusTab:!1,disableNativeSpellChecker:!0,disableNativeTableHandles:!0,disableObjectResizing:!1,disableReadonlyStyling:!1,docType:"<!DOCTYPE html>",editingBlock:!0,emailProtection:"",enableTabKeyTools:!0,enterMode:d.ENTER_P,entities:!0,entities_additional:"#39",entities_greek:!0,entities_latin:!0,entities_processNumerical:!1,extraPlugins:"",filebrowserBrowseUrl:"",filebrowserFlashBrowseUrl:"",filebrowserFlashUploadUrl:"",filebrowserImageBrowseLinkUrl:"",filebrowserImageBrowseUrl:"",filebrowserImageUploadUrl:"",filebrowserUploadUrl:"",filebrowserWindowFeatures:"",filebrowserWindowHeight:"",filebrowserWindowWidth:"",fillEmptyBlocks:!0,find_highlight:{element:"span",styles:{"background-color":"#ff0",color:"#00f"}},font_defaultLabel:"Arial",font_names:"Arial;Times New Roman;Verdana",font_style:{element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},fontSize_defaultLabel:"12px",fontSize_sizes:"8/8px;9/9px;10/10px;11/11px;12/12px;14/14px;16/16px;18/18px;20/20px;22/22px;24/24px;26/26px;28/28px;36/36px;48/48px;72/72px",fontSize_style:{element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},forceEnterMode:!1,forcePasteAsPlainText:!1,forceSimpleAmpersand:!1,format_address:{element:"address"},format_div:{element:"div"},format_h1:{element:"h1"},format_h2:{element:"h2"},format_h3:{element:"h3"},format_h4:{element:"h4"},format_h5:{element:"h5"},format_h6:{element:"h6"},format_p:{element:"p"},format_pre:{element:"pre"},format_tags:"p;h1;h2;h3;h4;h5;h6;pre;address;div",fullPage:!1,height:30,htmlEncodeOutput:!1,ignoreEmptyParagraph:!0,image_previewText:" ",image_removeLinkByEmptyURL:!0,indentClasses:null,indentOffset:40,indentUnit:"px",jqueryOverrideVal:!0,justifyClasses:null,keystrokes:[[d.ALT+121,"toolbarFocus"],[d.ALT+122,"elementsPathFocus"],[d.SHIFT+121,"contextMenu"],[d.CTRL+90,"undo"],[d.CTRL+89,"redo"],[d.CTRL+d.SHIFT+90,"redo"],[d.CTRL+76,"link"],[d.CTRL+66,"bold"],[d.CTRL+73,"italic"],[d.CTRL+85,"underline"],[d.ALT+109,"toolbarCollapse"]],language:"",menu_groups:"clipboard,form,tablecell,tablecellproperties,tablerow,tablecolumn,table,anchor,link,image,flash,checkbox,radio,textfield,hiddenfield,imagebutton,button,select,textarea",newpage_html:"",pasteFromWordCleanupFile:"default",pasteFromWordNumberedHeadingToList:!1,pasteFromWordPromptCleanup:void 0,pasteFromWordRemoveFontStyles:!1,pasteFromWordRemoveStyles:!0,plugins:"dialogui,dialog,about,a11yhelp,basicstyles,blockquote,clipboard,panel,floatpanel,menu,contextmenu,button,toolbar,enterkey,entities,popup,filebrowser,floatingspace,listblock,richcombo,format,horizontalrule,htmlwriter,wysiwygarea,image,indent,indentlist,fakeobjects,link,list,magicline,maximize,pastetext,pastefromword,removeformat,sourcearea,specialchar,menubutton,scayt,stylescombo,tab,table,tabletools,undo,wsc",protectedSource:[],readOnly:!1,removeDialogTabs:"link:advanced",removeFormatAttributes:"class,style,lang,width,height,align,hspace,valign",removeFormatTags:"b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var",removePlugins:"elementspath,resize,save,font",resize_dir:"both",resize_enabled:!0,resize_maxHeight:800,resize_maxWidth:0,resize_minHeight:100,resize_minWidth:290,scayt_autoStartup:!1,scayt_contextCommands:"all",scayt_contextMenuItemsOrder:"suggest|moresuggest|control",scayt_customDictionaryIds:"",scayt_customerid:"",scayt_maxSuggestions:5,scayt_moreSuggestions:"on",scayt_sLang:"en_US",scayt_srcUrl:"",scayt_uiTabs:"1,1,1",scayt_userDictionaryName:"",sharedSpaces:void 0,shiftEnterMode:d.ENTER_BR,skin:"moono",smiley_columns:8,smiley_descriptions:["smiley","sad","wink","laugh","frown","cheeky","blush","surprise","indecision","angry","angel","cool","devil","crying","enlightened","no","yes","heart","broken heart","kiss","mail"],smiley_images:["regular_smile.gif","sad_smile.gif","wink_smile.gif","teeth_smile.gif","confused_smile.gif","tounge_smile.gif","embaressed_smile.gif","omg_smile.gif","whatchutalkingabout_smile.gif","angry_smile.gif","angel_smile.gif","shades_smile.gif","devil_smile.gif","cry_smile.gif","lightbulb.gif","thumbs_down.gif","thumbs_up.gif","heart.gif","broken_heart.gif","kiss.gif","envelope.gif"],smiley_path:d.basePath+"plugins/smiley/images/",specialChars:[],startupFocus:!1,startupMode:"wysiwyg",startupOutlineBlocks:!1,startupShowBorders:!0,stylesheetParser_skipSelectors:/(^body\.|^\.)/i,stylesheetParser_validSelectors:/\w+\.\w+/,stylesSet:[],tabIndex:0,tabSpaces:0,templates:"default",templates_files:["plugins/templates/templates/default.js"],templates_replaceContent:!0,toolbar:"Basic",toolbar_Basic:[["Bold","Italic","Underline","-","NumberedList","BulletedList","-","Link","-"]],toolbar_Full:[{name:"document",items:["Source","-","Save","NewPage","DocProps","Preview","Print","-","Templates"]},{name:"clipboard",items:["Cut","Copy","Paste","PasteText","PasteFromWord","-","Undo","Redo"]},{name:"editing",items:["Find","Replace","-","SelectAll","-","SpellChecker","Scayt"]},{name:"forms",items:["Form","Checkbox","Radio","TextField","Textarea","Select","Button","ImageButton","HiddenField"]},"/",{name:"basicstyles",items:["Bold","Italic","Underline","Strike","Subscript","Superscript","-","RemoveFormat"]},{name:"paragraph",items:["NumberedList","BulletedList","-","Outdent","Indent","-","Blockquote","CreateDiv","-","JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock","-","BidiLtr","BidiRtl"]},{name:"links",items:["Link","Unlink","Anchor"]},{name:"insert",items:["Image","Flash","Table","HorizontalRule","Smiley","SpecialChar","PageBreak"]},"/",{name:"styles",items:["Styles","Format","Font","FontSize"]},{name:"colors",items:["TextColor","BGColor"]},{name:"tools",items:["Maximize","ShowBlocks","-","About"]}],toolbarCanCollapse:!1,toolbarGroupCycling:!0,toolbarLocation:"bottom",toolbarStartupExpanded:!0,uiColor:"#EBEBEB",undoStackSize:20,useComputedState:!0,width:""}}),a.define("view.Commenting",b)}(crafter.social),function(a){"use strict";var b,c=a.view.Base,d=a.$,e=".dropdown-backdrop",f='[data-toggle="dropdown"]';b=c.extend({tagName:"ul",className:"list-inline list-unstyled crafter-social-view-options-view",initialize:function(){c.prototype.initialize.apply(this,arguments);var b=this;d.each(this.cfg.hidden,function(c,d){b.$(a.string.fmt('[data-option="%@"]',d)).hide()}),this.$("[data-toggle]").dropdown()},sortBy:function(a,b,c){this.cfg.sortBy=b,this.cfg.sortOrder=c,this.refresh()},refresh:function(){this.cfg.sortOrder||this.cfg.sortBy||(this.cfg.sortOrder="DESC",this.cfg.sortBy="createdDate"),this.collection.fetch({data:{target:this.cfg.target,context:this.cfg.context,sortBy:this.cfg.sortBy,sortOrder:this.cfg.sortOrder}})},changeView:function(a,b){this.closeDropdown(),this.trigger("view.change.request",b)},close:function(){this.closeDropdown(),this.trigger("view.close.request")},closeDropdown:function(){this.$(e).remove(),this.$(f).removeClass("open").parents("li.open").removeClass("open")}}),b.DEFAULTS={hidden:[],templates:{main:function(){return a.string.fmt("%@options.hbs",a.Cfg("url.templates"))}}},a.define("view.Options",b)}(crafter.social),function(a){"use strict";var b,c=a.view.Base,d=a.getDirector(),e=a.Constants,f=a.$;b=c.extend({className:[c.prototype.className,"crafter-social-discussion-view"].join(" "),listen:function(){var a=this.collection;a&&(this.listenTo(a,"add",this.addOne),this.listenTo(a,"sync",this.addAll))},createUI:function(){c.prototype.createUI.call(this),this.cfg.initCommentingView&&this.initCommentingView();var b=this.$(".options-view-container");if(b.size()){var d=new a.view.Options(f.extend({target:this.cfg.target,context:this.cfg.context,collection:this.collection},this.cfg.viewOptions||{}));d.render(),b.append(d.el),this.listenTo(d,"view.change.request",this.changeView),this.listenTo(d,"view.close.request",this.hide||a.util.emptyFn)}},initCommentingView:function(){var b=this.$(".reply-box"),c=a.getDirector().getProfile(),d=c.hasRole("SOCIAL_AUTHOR",this.cfg.context)||c.hasRole("SOCIAL_SUPERADMIN",this.cfg.context)||c.hasRole("SOCIAL_MODERATOR",this.cfg.context)||c.hasRole("SOCIAL_ADMIN",this.cfg.context);if(!d&&b.hide(),b.size()&&d){var e=new a.util.instance("view.Commenting",f.extend({collection:this.collection,context:this.cfg.context,target:this.cfg.target},this.cfg.commenting));b.append(e.render().el),this.cache("commentingView",e)}},changeView:function(a){this.trigger("view.change.request",a)},addAll:function(){var b,c=a.getDirector().getProfile(),g="";this.$(".comments:first").html(""),0===this.collection.length?(g="discussion.comment".loc(),f(this.el).find(".comments:empty").append('<span class="sui-log-event">'+g+"</span>"),b=f(this.el).find(".sui-log-event")):c.hasRole("SOCIAL_USER",this.cfg.context)||c.hasRole("SOCIAL_ADMIN",this.cfg.context)||c.hasRole("SOCIAL_MODERATOR",this.cfg.context)||f(this.el).find(".sui-comment-nonempty").length<=0&&(g="discussion.login-comment".loc(),f(this.el).find(".comments:last").after('<span class="sui-comment-nonempty">'+g+"</span>"),b=f(this.el).find(".sui-comment-nonempty")),f(b).on("click",function(){d.trigger(e.get("EVENT_SOCIAL_NOCOMMENT"))}),this.collection.each(this.addOne,this)},addOne:function(b){if(!b.isTrashed()){var c=(new Date).getTime();if(b.ts=c,this.$(".no-comments").remove(),!b.isReply()){var d=new a.view.Comment({model:b,context:this.cfg.context,collection:this.collection});this.$(".comments:first").append(d.render().element())}}}}),b.DEFAULTS=f.extend({},c.DEFAULTS,{initCommentingView:!0,commenting:{editor:{extraPlugins:"autogrow",autoGrow_maxHeight:800,removePlugins:"resize"}}}),a.define("view.Discussion",b)}(crafter.social),function(a){"use strict";var b,c=a.view.Discussion,d=a.$;b=c.extend({className:[c.prototype.className,"crafter-social-inline-view","panel-group"].join(" "),render:function(){c.prototype.render.apply(this,arguments);var a=this,b=this.$(a.cmpID("panel")),e=this.$(this.cmpID("toggler")),f=a.cfg.target;return this.$(this.cmpID("toggler")).attr("name",f.substring(1,f.length)+"-comments"),this.$(this.cmpID("toggler")).attr("id",f.substring(1,f.length)+"-comments"),e.click(function(){b.hasClass("in")?d(this).addClass("closed").removeClass("opened"):d(this).addClass("opened").removeClass("closed"),b.toggleClass("in")}).addClass("opened"),this},show:function(){this.$el.insertAfter(this.cfg.target),this.addAll();var a=this.cache("commentingView");a&&a.editor()},hide:function(){var a=this.cache("commentingView");a&&a.editor("destroy"),this.$el.detach()}}),b.DEFAULTS=d.extend({},c.DEFAULTS,{viewOptions:{hidden:["inline.request"]},templates:{main:"%@inline.hbs".fmt(a.Cfg("url.templates"))}}),a.define("view.Inline",b)}(crafter.social),function(a){"use strict";var b,c=a.view.Modal,d=a.view.Discussion,e=a.util,f=a.$,g=f.extend({},d.prototype,{className:[c.prototype.className,d.prototype.className,"crafter-social-lightbox-view"].join(" "),initialize:function(){c.prototype.initialize.apply(this,arguments),d.prototype.initialize.apply(this,arguments)},listen:function(){c.prototype.listen.apply(this,arguments),d.prototype.listen.apply(this,arguments);var a=this;f(this.$el).one("shown.bs.modal",function(){a.initCommentingView()})},createUI:function(){c.prototype.createUI.apply(this,arguments),this.$(".modal-header").prepend('<div class="options-view-container pull-right"></div>').find(".modal-title").text("Full Thread View").end().find(".close").remove(),this.$(".modal-body").after(this.getTemplate("comment-box")),this.$("footer.modal-footer").addClass("reply-box"),d.prototype.createUI.apply(this,arguments)},render:function(){var a=f(this.cfg.target),b=a.clone(),d={"font-size":"inherit","text-align":"inherit"},e=this;b.css(this.compileStyles(a,null,{"margin-bottom":0})),b.find(">*, >*>*, >*>*>*").each(function(){f(this).css(e.compileStyles(this,d))}),b.removeClass("reveal crafter-social-commentable");var g=this.$(".modal-body");return g.html(""),g.append(b),this.addAll(),c.prototype.render.apply(this,arguments)},compileStyles:function(b,c,d){try{if("getMatchedCSSRules"in a.window){var g,h={},i=a.window.getMatchedCSSRules(b instanceof f?b.get(0):b),j=[];return i&&f.each(i,function(a,b){var c=b.cssText;if(-1===c.indexOf("crafter-social")){var d=c.match(/\{(.+?)\}/g)[0].replace(/\{/g,"").replace(/\}/g,"")+";";j.push(d)}}),g=j.j().split(";"),f.each(g,function(a,b){if(""!==b.trim()){var c=b.split(":");h[c[0].trim()]=c[1].trim()}}),f.extend({},c||{},h,d||{})}return{}}catch(k){return e.log(k.message||k),{}}}});delete g.constructor,b=c.extend(g),b.DEFAULTS=f.extend(!0,{},c.DEFAULTS,d.DEFAULTS,{classes:null,initCommentingView:!1,viewOptions:{hidden:["lightbox.request"]},templates:{"comment-box":['<div class="modal-comment-box">','<h4 class="comment-box-title">Comments</h4>','<div class="comments crafter-social-comment-thread">','<div class="no-comments">(no comments)</div>',"</div>","</div>"].join("")}}),b.DEFAULTS.classes=[].concat(c.DEFAULTS.classes||[]).concat(d.DEFAULTS.classes||[]),b.DEFAULTS.classes.push("crafter-social-lightbox-view"),a.define("view.Lightbox",b)}(crafter.social),function(a){"use strict";if(!a.$.fn.popover)throw new Error("Popover requires bootstrap popover");var b,c=a.view.Discussion,d=a.$,e=d.extend({},d.fn.popover.Constructor.prototype,{className:[c.prototype.className,"crafter-social-popover","popover","fade"].join(" "),events:{"click button.close":"hide"},initialize:function(){this.visible=!1,c.prototype.initialize.apply(this,arguments),this.init("popover",this.cfg.target,this.cfg.popover),this.$tip=this.element(),this.addAll()},addOne:function(){c.prototype.addOne.apply(this,arguments)},listen:function(){c.prototype.listen.apply(this,arguments);var a=this;d(this.cfg.target).on("hidden.bs.popover",function(){a.trigger("visibility.change",!1),a.visible=!1}).on("shown.bs.popover",function(){var b=a.cache("commentingView");b&&b.editor(),a.trigger("visibility.change",!0),a.visible=!0})},render:function(){c.prototype.render();var a=this.$(".crafter-social-comment-thread");return a.on("mousewheel DOMMouseScroll",function(b){var c=this.scrollTop,d=b.originalEvent.detail<0||b.originalEvent.wheelDelta>0?1:-1;0>d&&a.outerHeight()+this.scrollTop===this.scrollHeight?b.preventDefault():d>=0&&0===c&&b.preventDefault()}),this},refresh:function(){this.collection.fetch({data:{target:this.cfg.target,context:this.cfg.context}})},replacement:function(){this.show()},hide:function(){var a=this.cache("commentingView");a&&a.editor("destroy");var b=d.Event("hide.bs."+this.type);return this.$tip.removeClass("in"),"in"!==this.hoverState&&this.$tip.detach(),this.$element.trigger(b),this.$element.trigger("hidden.bs."+this.type),this},getDefaults:function(){return b.DEFAULTS},getOptions:function(a){return a=d.extend({},this.getDefaults(),a,this.$element.data()),a.delay&&"number"==typeof a.delay&&(a.delay={show:a.delay,hide:a.delay}),a},setContent:function(){this.tip().removeClass("fade top bottom left right in hide")},tip:function(){return this.element()}});delete e.constructor,b=c.extend(e),b.DEFAULTS=d.extend({},c.DEFAULTS,{
templates:{main:"%@popover.hbs".fmt(a.Cfg("url.templates")),comment:"%@comment.hbs".fmt(a.Cfg("url.templates"))},popover:d.extend({},d.fn.popover.Constructor.DEFAULTS,{placement:"bottom",trigger:"manual",container:"body",content:"(not.empty)"}),viewOptions:{hidden:["close","popover.request"]}}),a.define("view.Popover",b)}(crafter.social),function(a){"use strict";var b,c="reveal",d=a.view.Base,e=a.Constants,f=a.getDirector(),g=a.util,h=a.$,i=a.window.setTimeout,j=a.window.clearTimeout;b=d.extend({hide:!1,reveal:!0,timeout:null,className:"crafter-social-commentable",revealed:!1,events:{mouseenter:"mouseenter",mouseleave:"mouseleave"},initialize:function(a){this.setElement(a.target),d.prototype.initialize.apply(this,arguments),this.delegateActions(this,this.$options),this.collection.fetch({data:{id:this.cfg.target,sortBy:a.sortBy,sortOrder:a.sortOrder}})},listen:function(){var b=this;h(a.window).resize(function(){b.revealed&&b.mouseenter()}),this.listenTo(this.collection,"sync",this.render),this.listenTo(this.collection,e.get("EVENT_DISCUSSION_WATCHED",this.cfg),this.setWatched),this.listenTo(f,e.get("EVENT_AREAS_VISIBILITY_CHANGE"),this.visibilityModeChanged),this.listenTo(f,e.get("EVENT_REVEAL_DISCUSSIONS",this.cfg),this.revealDiscussion)},createUI:function(){var a=this,b=this.element();b.addClass("crafter-social-commentable");var c=h(g.template(this.getTemplate("main"),{count:""}));c.find("a.action").tooltip(),c.mouseenter(function(){j(a.timeout)}),c.mouseleave(function(){a.timeout=i(function(){a.mouseleave()})}),this.$options=c},render:function(){var a=this.$options.find(".badge"),b=this.collection.length,c=this.cfg.target;this.$options.find("#socialCommentBadge").attr("href","#"+c.substring(1,c.length)+"-comments"),0===b?a.text(""):a.text(b);var d=this.collection.getIsWatched();return this.setWatched(d),this},visibilityModeChanged:function(a){switch(a){case e.get("AREA_VISIBILITY_MODE_REVEAL"):this.hide=!1,this.reveal=!0,this.$el.is(":visible")&&this.mouseenter();break;case e.get("AREA_VISIBILITY_MODE_HOVER"):this.hide=!1,this.reveal=!1,this.$el.is(":visible")&&this.mouseleave();break;case e.get("AREA_VISIBILITY_MODE_HIDE"):this.hide=!0,this.reveal=!1,this.$el.is(":visible")&&this.mouseleave()}},inline:function(){var b=this.cache("view.Inline");b||(b=new a.view.Inline({target:this.cfg.target,context:this.cfg.context,collection:this.collection}),this.cache("view.Inline",b),this.listenTo(b,"view.change.request",this.viewChangeRequest),b.render()),b.show(),this.setActiveView(b)},lightbox:function(){var b=this.cache("view.Lightbox");b||(b=new a.view.Lightbox({target:this.cfg.target,context:this.cfg.context,collection:this.collection}),this.cache("view.Lightbox",b),this.listenTo(b,"view.change.request",this.viewChangeRequest),b.render()),b.show(),this.setActiveView(b)},popover:function(){var b=this.cache("view.Popover");b||(b=new a.view.Popover({target:this.cfg.target,context:this.cfg.context,collection:this.collection}),this.cache("view.Popover",b),this.listenTo(b,"visibility.change",this.popoverVisibilityDidChange),this.listenTo(b,"view.change.request",this.viewChangeRequest),b.render()),b.show(),this.setActiveView(b)},setActiveView:function(a){this.activeView=a},popoverVisibilityDidChange:function(a){this.$el[a?"addClass":"removeClass"]("revealed-by-view")},revealDiscussion:function(a){if(!(a instanceof h.Event)&&"object"==typeof arguments[0]){var b=arguments[0];b.view&&(this.cfg.discussionView=b.view)}this.viewChangeRequest(this.cfg.discussionView),a&&h("html, body").animate({scrollTop:h(h(a.currentTarget).attr("href")).offset().top},500)},viewChangeRequest:function(a){var b=this;switch(h.each(["view.Popover","view.Lightbox","view.Inline"],function(a,c){var d=b.cache(c);d&&d.hide()}),a){case"view.Popover":this.popover(),h("body, html").animate({scrollTop:this.$el.offset().top+this.$el.height()},1e3);break;case"view.Lightbox":this.lightbox();break;case"view.Inline":this.inline()}this.cfg.discussionView=a},watch:function(){var b=this.collection,c=b.getIsWatched();a.request({type:"POST",context:this,data:{frequency:"INSTANT"},url:a.url(c?"threads.{_id}.unsubscribe":"threads.{_id}.subscribe",{_id:this.cfg.target,context:this.cfg.context}),success:function(){b.setIsWatched(!c)},error:function(){}})},setWatched:function(a){var b=this.$options.find('[data-action="watch"]');b.parents("li:first")[null===a?"addClass":"removeClass"]("hide"),b.show().css("color",a?"green":"")},mouseenter:function(){if(!this.hide){j(this.timeout);var a=this.element(),b=this.$options;a.addClass(c);var d=a.offset(),e=a.outerWidth();b.appendTo("body").show();var f=b.outerWidth();b.hide(),b.css({left:d.left+e-f,top:d.top}).show(),this.revealed=!0}},mouseleave:function(){if(!this.reveal){var a=this;a.timeout=i(function(){a.element().removeClass(c),a.$options.hide().detach(),a.revealed=!1},10)}}}),b.DEFAULTS={templates:{main:function(){return a.string.fmt("%@commentable.hbs",a.Cfg("url.templates"))}},discussionView:"view.Popover"},a.define("view.Commentable",b)}(crafter.social),function(a){"use strict";var b,c=a.view.Base,d=a.util,e=a.$,f=" ";b=c.extend({icon:"",title:"",shown:!1,attributes:{style:"display: none;"},events:{"click [data-dismiss]":"hide","click button.submit":"submit","keypress .form-control":"keypress"},initialize:function(d){d.classes&&(d.classes=(a.util.isArray(d.classes)?d.classes:d.classes.split(f)).concat(b.DEFAULTS.classes)),c.prototype.initialize.call(this,e.extend(!0,{},b.DEFAULTS,d));var g=this.bar,h=this.guid;this.listenTo(g,"%@.activate".fmt(h),this.activate),this.render()},render:function(){this.$el.appendTo(this.bar.el)},activate:function(a){this[this.shown?"hide":"show"]()},message:function(a){var b=this;this.$el.prepend(d.template(this.getTemplate("message"),a)),setTimeout(function(){b.$(".alert").remove(),a.callback&&a.callback.call(b,a)},3e3)},toggle:function(){this.$el.toggle("fast"),this.shown=!this.shown},show:function(){this.$el.show("fast"),this.shown=!0},hide:function(){this.$el.hide("fast"),this.shown=!1}}),b.DEFAULTS={classes:["crafter-social-bar-widget"],templates:{message:'<div class="alert alert-success"><i class="crafter-social-icon cs-icon-{{icon}}"></i> {{msg}}</div>'}},a.define("view.barget.Base",b)}(crafter.social),function(a){"use strict";var b,c=a.view.barget.Base,d=a.Constants;b=c.extend({icons:{reveal:"cs-icon-eye-open",hover:"cs-icon-hand-up"},icon:"eye-open",title:"Discussion",render:a.util.emptyFn,createUI:a.util.emptyFn,events:{"button .submit":"submit","keypress .form-control":"keypress"},listen:function(){this.listenTo(a.getDirector(),d.get("EVENT_AREAS_VISIBILITY_CHANGE"),this.visibilityModeChanged)},visibilityModeChanged:function(a){switch(a){case d.get("AREA_VISIBILITY_MODE_REVEAL"):this.$trigger.find(".text:first").text("Hover").end().find("i").removeClass(this.icons.reveal).addClass(this.icons.hover);break;case d.get("AREA_VISIBILITY_MODE_HIDE"):case d.get("AREA_VISIBILITY_MODE_HOVER"):this.$trigger.find(".text:first").text("Reveal").end().find("i").removeClass(this.icons.hover).addClass(this.icons.reveal)}},activate:function(b){a.getDirector().getAreaVisibilityMode()!==d.get("AREA_VISIBILITY_MODE_REVEAL")?a.getDirector().setAreaVisibilityMode(d.get("AREA_VISIBILITY_MODE_REVEAL")):a.getDirector().setAreaVisibilityMode(d.get("AREA_VISIBILITY_MODE_HOVER"))}}),a.define("view.barget.Reveal",b,!0)}(crafter.social),function(a){"use strict";var b,c=a.view.barget.Base,d=a.Constants;b=c.extend({icons:{enabled:"cs-icon-remove-sign",disabled:"cs-icon-ok-circle"},icon:"remove-sign",title:"Discussion",render:a.util.emptyFn,createUI:a.util.emptyFn,events:{"button .submit":"submit","keypress .form-control":"keypress"},listen:function(){this.listenTo(a.getDirector(),d.get("EVENT_AREAS_VISIBILITY_CHANGE"),this.visibilityModeChanged)},visibilityModeChanged:function(a){switch(a){case d.get("AREA_VISIBILITY_MODE_REVEAL"):case d.get("AREA_VISIBILITY_MODE_HOVER"):this.$trigger.find(".text:first").text("Disable").end().find("i").removeClass(this.icons.disabled).addClass(this.icons.enabled);break;case d.get("AREA_VISIBILITY_MODE_HIDE"):this.$trigger.find(".text:first").text("Enable").end().find("i").removeClass(this.icons.enabled).addClass(this.icons.disabled)}},activate:function(b){a.getDirector().getAreaVisibilityMode()!==d.get("AREA_VISIBILITY_MODE_HIDE")?a.getDirector().setAreaVisibilityMode(d.get("AREA_VISIBILITY_MODE_HIDE")):a.getDirector().setAreaVisibilityMode(d.get("AREA_VISIBILITY_MODE_HOVER"))}}),a.define("view.barget.Disable",b,!0)}(crafter.social),function(a){"use strict";var b,c=a.view.Base,d=a.util,e=a.$;b=c.extend({events:{"click .control-element":"toggle","click [data-activate-widget]":"activate","click .social-utilities a":function(a){a.preventDefault()}},initialize:function(a){var d=e.extend({},b.DEFAULTS,a);c.prototype.initialize.call(this,d),this.initializeWidgets()},initializeWidgets:function(){var a=this.cfg.widgets,b=this.$(".social-utilities"),c=this.getTemplate("widget"),f={},g=this;e.each(a,function(a,h){if(h){var i,j=h.cls,k=e.extend({},h.cfg||{},{bar:g});"string"==typeof h.cls&&(j=d.get(h.cls)),i=new(j.extend(k))(h.instCfg),f[i.guid]=i,i.$trigger=e(d.template(c,i)),b.append(i.$trigger)}}),this.widgets=f},activate:function(a){var b=e(a.target),c=b.data("activateWidget");!c&&(c=b.parents("[data-activate-widget]:first").data("activateWidget")),e.each(this.widgets,function(a,b){c!==a&&b.hide()}),this.trigger("%@.activate".fmt(c),b)},collapsed:!1,_collapseData:null,toggle:function(){if(!this._collapseData){var a=this.$(".control-element");this._collapseData={$ctrl:a,width:this.$el.outerWidth(),ctrlWidth:a.outerWidth()}}var b=this.$el,c=this._collapseData;b.animate({right:this.collapsed?0:c.ctrlWidth-c.width},100,function(){}),this.collapsed=!this.collapsed}}),b.DEFAULTS={templates:{main:"%@social-bar.hbs".fmt(a.Cfg("url.templates")),widget:['<li class="subordinate">','<a data-activate-widget="{{guid}}">','<i class="crafter-social-icon cs-icon-{{icon}}"></i> <span class="text">{{title}}</span>',"</a>","</li>"].j()},classes:["crafter-social-bar"],widgets:[{cls:"crafter.social.view.barget.Reveal",cfg:{title:"Reveal"},instCfg:{}},{cls:"crafter.social.view.barget.Disable",cfg:{title:"Disable"},instCfg:{}}]},a.define("view.SocialBar",b)}(crafter.social),function(a){"use strict";var b,c=a.view.Modal,d=a.Constants,e=a.getDirector(),f=a.model.Profile,g=a.$,h=a.util;b=c.extend({className:[c.prototype.className,"crafter-social-auth-view"].join(" "),events:{"click #submitBtn_%@":"submit"},initialize:function(){c.prototype.initialize.apply(this,arguments),!this.model&&(this.model=new f)},login:function(){c.prototype.login.apply(this,arguments),f.authenticate()},listen:function(){c.prototype.listen.apply(this,arguments);var a=this;this.$el.on("shown.bs.modal",function(){a.$("input:first").select()}),this.listenTo(e,d.get("EVENT_USER_AUTHENTICATION_SUCCESS"),this.destroy),this.listenTo(e,d.get("EVENT_USER_AUTHENTICATION_FAILED"),this.failure)},createUI:function(){c.prototype.createUI.apply(this,arguments),this.$(".modal-title:first").text("Login"),this.$(".modal-body:first").html(h.template(this.getTemplate("form"),{guid:this.guid,action:a.Cfg("url.security"),method:"post"})),this.$(".modal-footer:first").html(h.template(this.getTemplate("submit"),this))},render:function(){c.prototype.render.apply(this,arguments);var a=this.model.toJSON();this.setFormData(a);var b=this;return this.$el.on("hidden.bs.modal",function(){b.destroy()}),this},setFormData:function(a){this.$("form").find("input, textarea, select").each(function(){var b=g(this);b.val(a[b.attr("name")])})},getFormData:function(){var a={};return this.$("form").find("input, textarea, select").each(function(){var b=g(this);a[b.attr("name")]=b.val()}),a},submit:function(){this.setMessage({type:"info",icon:"info-sign",message:"Loading, please wait&hellip;"});var a=this.getFormData();this.model.set(a),this.model.authenticate()},failure:function(){this.setMessage({type:"danger",icon:"warning-sign",message:"Your credentials were not recognized"}),this.$("input:first").select()},setMessage:function(a){var b=this.$(".modal-body");b.find(".alert").remove(),a&&b.prepend(h.template(this.getTemplate("message"),a))}}),b.DEFAULTS=g.extend(!0,{},c.DEFAULTS,{templates:{form:"%@auth-form.hbs".fmt(a.Cfg("url.templates")),submit:'<button data-indentifyme="submitBtn" class="btn btn-primary">Submit</button>',message:['<div class="alert alert-{{type}}">','<i class="crafter-social-icon cs-icon-{{icon}}"></i> {{html message}}',"</div>"].join("")}}),a.define("view.Auth",b)}(crafter.social),function(a){"use strict";var b,c=a.view.Base,d=a.util,e=a.$;b=c.extend({createUI:null,className:[c.prototype.className,"crafter-social-file-view"].join(" "),open:function(){},detach:function(){},render:function(){var a=this.getTemplate("main");return this.$el.html(d.template(a,this.model.toJSON())),this}}),b.DEFAULTS=e.extend(!0,{},c.DEFAULTS,{templates:{main:function(){return a.string.fmt("%@file.hbs",a.Cfg("url.templates"))}}}),a.define("view.File",b)}(crafter.social),function(a){"use strict";var b,c=a.view.Base,d=a.util,e=a.$;b=c.extend({className:[c.prototype.className,"crafter-social-view","crafter-social-files-view","crafter-social-dropbox-element"].join(" "),listen:function(){var a=this.collection;this.listenTo(a,"add",this.addOne),this.listenTo(a,"sync",this.addAll)},addAll:function(){this.$(".cs-files-list:first").html(""),this.collection.each(this.addOne,this)},addOne:function(b){var c=new a.view.File({model:b});this.$(".cs-files-list:first").append(c.render().el)},uploadComplete:function(a){e(a.ui).remove();var b=d.fromJSON(a.e.target.responseText),c=new File(b);this.addOne(c)}}),b.DEFAULTS=e.extend(!0,{},c.DEFAULTS,{templates:{main:function(){return a.string.fmt("%@files.hbs",a.Cfg("url.templates"))},file:function(){return a.string.fmt("%@file.hbs",a.Cfg("url.templates"))}}}),a.define("view.Files",b)}(crafter.social),function(a){"use strict";var b=a.window.crafterSocial_onAppReady,c=[a.getDirector(),a];a.util.isArray(b)?b.every(function(a){return a.apply(null,c)}):b&&b.apply(null,c)}(crafter.social);
//# sourceMappingURL=true